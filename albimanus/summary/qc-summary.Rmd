---
  html_document:
    toc: true
    highlight: zenburn
    theme: united
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(tidy=TRUE, highlight=TRUE, dev="png",
               cache=TRUE, highlight=TRUE, autodep=TRUE, warning=FALSE, error=FALSE,
               message=FALSE, prompt=TRUE, comment='', fig.cap='')
```

# Overview

```{r qc-setup}
library(ggplot2)
library(reshape)
library(gplots)
library(edgeR)
library(CHBUtils)
library(pheatmap)
library(knitr)
project_summary = "/Users/rory/cache/mosquito-rnaseq/albimanus/project-summary.csv"
counts_file = "/Users/rory/cache/mosquito-rnaseq/albimanus/combined.counts"
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442",
"#0072B2", "#D55E00", "#CC79A7")
summarydata = read.table(project_summary, header=TRUE, sep=",")
rownames(summarydata) = summarydata$Name
summarydata = summarydata[order(summarydata$Name),]
counts = read.table(counts_file, header=TRUE, row.names="id")
counts = counts[, order(colnames(counts))]
# this is a list of all non user-supplied metadata columns that could appear
known_columns = c("Name", "X.GC", "Exonic.Rate", "Sequences.flagged.as.poor.quality",
    "rRNA.rate", "Fragment.Length.Mean", "Intronic.Rate", "Intergenic.Rate",
    "Mapping.Rate", "Quality.format", "Duplication.Rate.of.Mapped", "Mapped",
    "rRNA", "Sequence.length", "Transcripts.Detected", "Mean.Per.Base.Cov.",
    "Genes.Detected", "Unique.Starts.Per.Read", "unique_starts_per_read",
    "complexity")
batch2 = read.table("../batch_2_samples.txt", sep="\t")
batch2$batch = 2
m = merge(summarydata, batch2, by.x="Name", by.y="V1", all.x=TRUE)
m$batch[is.na(m$batch)] = 1
summarydata = m
summarydata = summarydata[, ! colnames(summarydata) %in% c("species", "time")]
summarydata$tissue_status = as.factor(paste(summarydata$tissue, summarydata$status, sep="_"))
rownames(summarydata) = summarydata$Name

```

```{r heatmap-function}
get_heatmap_fn = function(summarydata) {
    # return the pheatmap function with or without metadata
    metadata = summarydata[, !colnames(summarydata) %in% known_columns, drop=FALSE]
    metadata = cbind(metadata, summarydata[, c("Mapping.Rate", "X.GC")])
    if(ncol(metadata) == 0) {
       return(pheatmap)
    }
    else {
    rownames(metadata) = summarydata$Name
    heatmap_fn = function(data, ...) {
        pheatmap(data, annotation=metadata, ...)
    }
    return(heatmap_fn)
}}
heatmap_fn = get_heatmap_fn(summarydata)
```

# Quality control metrics

## Summary statistics of summarydata
```{r summaries}

numeric_columns = c("X.GC", "Exonic.Rate", "rRNA.rate", "Intronic.Rate",
    "Intergenic.Rate", "Mapping.Rate", "Mapped", "Fragment.Length.Mean", "Genes.Detected",
    "Transcripts.Detected")
sumdf = data.frame(summary(summarydata[, numeric_columns]))


## Mapped reads
```{r mapped-plot}
ggplot(summarydata, aes(x=Name, y=Mapped)) +
    theme_bw(base_size=10) +
    theme(panel.grid.major = element_line(size = .5, color = "grey"),
          axis.text.x = element_text(angle=90)) +
    geom_bar(stat="identity") +
    ylab("mapped reads") + xlab("") 
```

## Genomic mapping rate
```{r mapping-rate-plot}
ggplot(summarydata, aes(x=Name, y=Mapping.Rate)) +
    geom_bar(stat="identity") +
    ylab("mapping rate") + xlab("") +
    theme_bw(base_size=10) +
    theme(panel.grid.major = element_line(size = .5, color = "grey"),
          axis.text.x = element_text(angle=90)) 
```

## Number of genes detected
```{r genes-detected-plot}
ggplot(summarydata, aes(x=Name, y=Genes.Detected)) +
    geom_bar(stat="identity") +
    theme_bw(base_size=10) +
    theme(panel.grid.major = element_line(size = .5, color = "grey"),
          axis.text.x = element_text(angle=90)) +
    ylab("genes detected") + xlab("") 
```

## Exonic mapping rate
```{r exonic-mapping-plot}
ggplot(summarydata, aes(x=Name, y=Exonic.Rate)) +
    geom_bar(stat="identity") +
    theme_bw(base_size=10) +
    theme(panel.grid.major = element_line(size = .5, color = "grey"),
          axis.text.x = element_text(angle=90)) +
    ylab("exonic mapping rate") + xlab("") 
```

## rRNA mapping rate
```{r rRNA-rate-plot}
ggplot(summarydata, aes(x=Name, y=rRNA.rate)) +
    geom_bar(stat="identity") +
    theme_bw(base_size=10) +
    theme(panel.grid.major = element_line(size = .5, color = "grey"),
          axis.text.x = element_text(angle=90)) +
    ylab("rRNA rate") + xlab("") 
```

## Estimated fragment length of paired-end reads
```{r fragment-length-plot}
ggplot(summarydata, aes(x=Name, y=Fragment.Length.Mean)) +
    geom_bar(stat="identity") +
    theme_bw(base_size=10) +
    theme(panel.grid.major = element_line(size = .5, color = "grey"),
          axis.text.x = element_text(angle=90)) +
    ylab("fragment length") + xlab("")
```

## Boxplot of log10 counts per gene
```{r boxplot-raw}
melted = melt(counts)
colnames(melted) = c("sample", "count")
melted$sample = factor(melted$sample)
melted$sample = reorder(melted$sample, colnames(counts))
melted$count = log(melted$count)
ggplot(melted, aes(x=sample, y=count)) + geom_boxplot() +
    theme_bw(base_size=10) +
    theme(panel.grid.major = element_line(size = .5, color = "grey"),
          axis.text.x = element_text(angle=90)) + xlab("")
```

## Boxplot of log10 TMM-normalized counts per gene
Trimmed mean of M-values (TMM) normalization is described
[here](http://genomebiology.com/2010/11/3/R25)

Robinson, M. D., & Oshlack, A. (2010). A scaling normalization method for differential expression analysis of RNA-seq data. Genome Biology, 11(3). doi:10.1186/gb-2010-11-3-r25

```{r boxplot-normalized}
y = DGEList(counts=counts)
y = calcNormFactors(y)
normalized_counts = cpm(y, normalized.lib.sizes=TRUE)
melted = melt(normalized_counts)
colnames(melted) = c("gene", "sample", "count")
melted$sample = factor(melted$sample)
melted$sample = reorder(melted$sample, colnames(counts))
melted$count = log(melted$count)
ggplot(melted, aes(x=sample, y=count)) + geom_boxplot() +
    theme_bw(base_size=10) +
    theme(panel.grid.major = element_line(size = .5, color = "grey"),
          axis.text.x = element_text(angle=90)) + xlab("")
```

## Density of log10 TMM-normalized counts
```{r density-normalized}
ggplot(melted, aes(x=count, group=sample)) +
    geom_density() +
    theme_bw(base_size=10) +
    theme(panel.grid.major = element_line(size = .5, color = "grey"),
          axis.text.x = element_text(angle=90)) + xlab("")
```

## Correlation (Pearson) heatmap of TMM-normalized counts
```{r pearson-heatmap-normalized}
heatmap_fn(cor(normalized_counts, method="pearson"), fontsize=6)
```

GC content seems to cluster with tissue type with the head and rest of body having lower
GC content than the spermatheca, MAG and atrium.

## Correlation (Spearman) heatmap of TMM-normalized counts
```{r spearman-heatmap-normalized}
heatmap_fn(cor(normalized_counts, method="spearman"), fontsize=6)
```

One sample, DT3_ALBI_Sp_M is very different from all of the other samples. This has
the lower number of transcripts detected at 1.2k which is about 1/10th of the other samples.
This sample likely has some kind of either contamination issue or PCR artifact happening,
where a single gene or a small number of genes was sequenced repeatedly.


```{r outlier-sample, results='asis'}
kable(summarydata[summarydata$Name == "DT3_ALBI_Sp_M",], format="markdown")
```

as opposed to the first five samples sequenced:

```{r first-5, results='asis'}
kable(head(summarydata), format="markdown")
```

We should drop DT3_ALBI_Sp_M from the analysis.

```{r drop-DT3_ALBI_Sp_M}
summarydata = summarydata[!rownames(summarydata) == "DT3_ALBI_Sp_M",]
counts = counts[, !colnames(counts) == "DT3_ALBI_Sp_M"]
normalized_counts = normalized_counts[, !colnames(normalized_counts) == "DT3_ALBI_Sp_M"]
```

The overall exonic mapping rates is low:

```{r exonic-rate, results='asis'}
summary(summarydata$Exonic.Rate)
```

It isn't clear if these issues are due to the fact the genome/annotation for the mosquito
is poor or if there is a problem with the samples.

## MDS plot of TMM-normalized counts
```{r mds-normalized}
mds(normalized_counts, k=length(colnames(normalized_counts)) - 1)
```

There is pretty consistent separation of the head with M/V status, and maybe some separation
in MAG with M/V status, barring CT3, and an overall separation of tissue type. Interestingly,
atrium and rest of body samples look pretty similar to each other.

## Heatmap of top 30 most expressed genes
```{r top-count-genes, results='asis'}
select = order(rowMeans(counts),decreasing=TRUE)[1:30]
heatmap_fn(counts[select,])
```


# Differential expression
We'll look at differences that are driven by mating status in the same tissue. The way
we will do this is to create factors that describe both the tissue status and mating
status, and then do pairwise comparisons across those tissues. This will answer the
question of what genes are different in each specific tissue.

```{r de-setup}
library(DESeq2)
library(DEGreport)
library(vsn)
design = ~sex + tissue_status
condition = "tissue"
```

```{r deseq2-expression-analysis, results='asis'}
counts <- counts[rowSums(counts>0)>1,]
dds = DESeqDataSetFromMatrix(countData=counts, colData=summarydata, design = design)
dds = DESeq(dds)
```

Now that we have the differential expression calls using the tissue and status, we
can pull out the mating specific differences in each tissue.

### Atrium
```{r atrium-de}
atrium = results(dds, contrast=list(c("tissue_statusatrium_mated"),
                          c("tissue_statusatrium_virgin")))
write.table(atrium, file="atrium_deseq2.tsv", sep="\t", row.names=TRUE, col.names=TRUE,
            quote=FALSE)
atrium_de = subset(atrium, padj < 0.1)
```
There are `r nrow(atrium_de)` genes flagged as differentally expressed between
the atrium of mated and virgin samples, with `r nrow(subset(atrium_de, log2FoldChange > 0))`
upregulated in mated samples and `r nrow(subset(atrium_de, log2FoldChange < 0))` in atrium
samples.

There is quite a bit of variability between samples:

```{r atrium-ma}
plotMA(atrium)
```

```{r atrium-volcano}
atrium_stats = as.data.frame(atrium[, c(2,6)])
volcano_density_plot(atrium_stats, title=names(atrium_stats), lfc.cutoff=1.5)
```

### Head
```{r head-de}
head = results(dds, contrast=list(c("tissue_statushead_mated"),
                          c("tissue_statushead_virgin")))
write.table(head, file="head_deseq2.tsv", sep="\t", row.names=TRUE, col.names=TRUE,
            quote=FALSE)
head_de = subset(head, padj < 0.1)
```
There are `r nrow(head_de)` genes flagged as differentally expressed between
the atrium of mated and virgin samples, with `r nrow(subset(head_de, log2FoldChange > 0))`
upregulated in mated samples and `r nrow(subset(head_de, log2FoldChange < 0))` in atrium
samples.

There is quite a bit of variability between samples:

```{r head-ma}
plotMA(head)
```

```{r head-volcano}
head_stats = as.data.frame(head[, c(2,6)])
volcano_density_plot(head_stats, title=names(head_stats), lfc.cutoff=1.5)
```

### MAG
```{r MAG-de}
MAG = results(dds, contrast=list(c("tissue_statusMAG_mated"),
                          c("tissue_statusMAG_virgin")))
write.table(MAG, file="MAG_deseq2.tsv", sep="\t", row.names=TRUE, col.names=TRUE,
            quote=FALSE)
MAG_de = subset(MAG, padj < 0.1)
```
There are `r nrow(MAG_de)` genes flagged as differentally expressed between
the atrium of mated and virgin samples, with `r nrow(subset(MAG_de, log2FoldChange > 0))`
upregulated in mated samples and `r nrow(subset(MAG_de, log2FoldChange < 0))` in atrium
samples.

There is quite a bit of variability between samples:

```{r MAG-ma}
plotMA(MAG)
```

```{r MAG-volcano}
MAG_stats = as.data.frame(MAG[, c(2,6)])
volcano_density_plot(MAG_stats, title=names(MAG_stats), lfc.cutoff=1.5)
```

### body
```{r body-de}
body = results(dds, contrast=list(c("tissue_statusbody_mated"),
                          c("tissue_statusbody_virgin")))
write.table(body, file="body_deseq2.tsv", sep="\t", row.names=TRUE, col.names=TRUE,
            quote=FALSE)
body_de = subset(body, padj < 0.1)
```
There are `r nrow(body_de)` genes flagged as differentally expressed between
the atrium of mated and virgin samples, with `r nrow(subset(body_de, log2FoldChange > 0))`
upregulated in mated samples and `r nrow(subset(body_de, log2FoldChange < 0))` in atrium
samples.

There is quite a bit of variability between samples:

```{r body-ma}
plotMA(body)
```

```{r body-volcano}
body_stats = as.data.frame(body[, c(2,6)])
volcano_density_plot(body_stats, title=names(body_stats), lfc.cutoff=1.5)
```

### spermatheca
```{r spermatheca-de}
spermatheca = results(dds, contrast=list(c("tissue_statusspermatheca_mated"),
                          c("tissue_statusspermatheca_virgin")))
write.table(spermatheca, file="spermatheca_deseq2.tsv", sep="\t", row.names=TRUE, col.names=TRUE,
            quote=FALSE)
spermatheca_de = subset(spermatheca, padj < 0.1)
```
There are `r nrow(spermatheca_de)` genes flagged as differentally expressed between
the atrium of mated and virgin samples, with `r nrow(subset(spermatheca_de, log2FoldChange > 0))`
upregulated in mated samples and `r nrow(subset(spermatheca_de, log2FoldChange < 0))` in atrium
samples.

There is quite a bit of variability between samples:

```{r spermatheca-ma}
plotMA(spermatheca)
```

```{r spermatheca-volcano}
spermatheca_stats = as.data.frame(spermatheca[, c(2,6)])
volcano_density_plot(spermatheca_stats, title=names(spermatheca_stats), lfc.cutoff=1.5)
```

## PCA

Samples tend to cluster on the PCA plot by tissue and to a lesser degree mated/virgin status,
that is a good sign.

```{r pca}
rld = rlog(dds)
plotPCA(rld, intgroup=c("tissue", "status"))
```

## Effect of variance stabilization
There is a huge amount of dispersion between these samples. 

```{r deseq-diagnostics, results='asis'}
par(mfrow=c(1,3))
notAllZero <- (rowSums(counts(dds))>0)
rld <- rlog(dds)
vsd <- varianceStabilizingTransformation(dds)
rlogMat <- assay(rld)
vstMat <- assay(vsd)

meanSdPlot(log2(counts(dds,normalized=TRUE)[notAllZero,] + 1),
           ylim = c(0,2.5))
meanSdPlot(assay(rld[notAllZero,]), ylim = c(0,2.5))
meanSdPlot(assay(vsd[notAllZero,]), ylim = c(0,2.5))
```

## Dispersion estimates

```{r dispersion-estimate}
plotDispEsts(dds)
```

## Tissue markers
One of the things we can do with this data is to produce a set of tissue-specific markers.
We're looking for a set a gene signatures that can be used to classify the different tissues.

We'll do NMF to pull out gene signatures for the different individual tissues.

```{r limma-counts}
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000")

library(edgeR)
library(limma)
library(NMF)
design = ~sex + tissue_status
dge = DGEList(counts=counts)
dge = calcNormFactors(y)
voomed = voom(dge, plot=TRUE)
tissue_metadata = subset(summarydata, tissue != "body")
tissue_only = normalized_counts[, colnames(normalized_counts) %in% rownames(tissue_metadata)]
tissue_only = tissue_only[rowSums(tissue_only) > 1,]
adf_tissue = AnnotatedDataFrame(tissue_metadata[,c("sex", "tissue")], data.frame(labelDescription=c("sex", "tissue")))
x = ExpressionSet(as.matrix(tissue_only), adf_tissue)
n = nmf(x, 4,  seed=12345)
consensus = consensusmap(n, annCol=x)
consensusmap(n, annCol=x)
basismap(n, scale="r1", annColors=list(basis=cbPalette[5:8],
         consensus=brewer.pal(4, "Spectral")),
         main="Metagene Components - All Contributing Genes", Rowv=TRUE)
s = featureScore(n)
summary(s)
s = extractFeatures(n)
str(s)
z = featureScore(n)


numfeatures <- sapply(seq(0,1,0.01), function(num) {
  lapply(extractFeatures(n, num), function(x){
    length(x)
  })
})
minnumfeatures=20
rel.basis.contrib.cutoff <- max(seq(0,1,0.01)[apply(numfeatures,2, function(x) all(x>minnumfeatures))])

basismap(n, scale="r1", subsetRow=rel.basis.contrib.cutoff,annColors=list(basis=cbPalette[5:8], consensus=brewer.pal(4, "Spectral")), main="Metagene Components - Most Specific Genes")

coefmap(n, scale="c1", labCol=tissue_metadata$tissue, annColors=list(basis=cbPalette[5:9]))

# write out the metagene features

fs = featureScore(n)
features = extractFeatures(n, 0.90)
head_features = fs[features[[2]]]
head_features[is.na(head_features)] = 1
head_counts = tissue_only[names(head_features), colnames(tissue_only) %in% subset(summarydata, tissue == "head")$Name]
head_scores = head_features * log(rowMeans(head_counts))
head_plot = sort(head_scores, decreasing=TRUE)[1:50]

atrium_features = fs[features[[1]]]
atrium_features[is.na(atrium_features)] = 1
spermatheca_features = fs[features[[4]]]
spermatheca_features[is.na(spermatheca_features)] = 1
MAG_features = fs[features[[3]]]
MAG_features[is.na(MAG_features)] = 1

melted = melt(tissue_only[names(head_plot),])
m = merge(melted, summarydata, by.x="X2", by.y="Name")
ggplot(m, aes(X1, value, color=tissue)) + geom_point() + scale_y_log10() +
    theme_bw(base_size=10) +
    theme(panel.grid.major = element_line(size = .5, color = "grey"),
          axis.text.x = element_text(angle=90)) + xlab("") + ylab("score")

feature_score_only = sort(head_features, decreasing=TRUE)[1:50]
melted = melt(tissue_only[names(feature_score_only),])
m = merge(melted, summarydata, by.x="X2", by.y="Name")
ggplot(m, aes(X1, value, color=tissue)) + geom_point() + scale_y_log10() +
    theme_bw(base_size=10) +
    theme(panel.grid.major = element_line(size = .5, color = "grey"),
          axis.text.x = element_text(angle=90)) + xlab("") + ylab("score")
```
